# Adversarial training with Unrestricted Adversarial Examples
## CS236 Final Project
Final Report: https://drive.google.com/open?id=18YWWARGSbJyWrmbSm1JmQH51lEIJoleU

## Motivation 

Dataset augmentation is a well-known technique used to increase the generalization power of machine learning models by introducing samples derived from the original training set. 
However, it is not obvious which augmentation techniques can be helpful: while simple geometric transformations like translations, mirroring help increase the accuracy of image classifiers, introducing adversarial examples at train time is detrimental to the accuracy on clean inputs. 

This work focuses on leveraging generative models to perform data augmentation. We study the case of image classification on the CIFAR-100 dataset and compare different augmentation methods using deep generative models. In particular, we study the effect of augmenting the training set with unrestricted adversarial samples.

## Task definition

Our goal is to compare different augmentation techniques in the adversarial training setting where the loss is given as:
![loss](https://user-images.githubusercontent.com/13089230/63455306-64ffae00-c401-11e9-9107-e0273b120071.png)

where T is the augmentation technique.

We train on the CIFAR-100 dataset, a set of 60,000 32x32 color images labeled with 100 classes. Our baseline model is a DenseNet trained with the usual cross-entropy loss.  
![Densenet model](https://user-images.githubusercontent.com/13089230/63454651-14d41c00-c400-11e9-8966-5a7928b68710.png)

## Augmentation techniques 
### Generative model
For our generative model, we choose the Auxiliary Classifier GAN trained with Gradient Penalty. The generator and discriminator use ResNet layers. The resulting model allows us to generate samples from a chosen class that we can use for data augmentation.
 Below are some samples generated by the AC-GAN, where each column represents a fixed latent vector and each row is a different class. 
![ACGAN Result](https://user-images.githubusercontent.com/13089230/63454652-14d41c00-c400-11e9-9e33-0a272e49b259.png)

### Adversarial Samples
Adversarial samples are typically obtained by adding an imperceptible adversarial noise to an input image, which makes it difficult for the classifier to correctly classify. An easy way to defend against adversarial samples is to augment the training set with adversarial samples, but this has been shown to decrease the accuracy of the model on clean samples. Here, for comparison, we test data augmentation with adversarial samples generated with FGSM (Fast Gradient Sign Method)

### Unrestricted Adversarial Samples
We generate unrestricted adversarial samples using our trained generative model by optimizing the latent variable z to produce an image that will be misclassified by the classifier. Details can be found in the final report. 


Top: clean samples generated by the AC-GAN. Our DenseNet model has 89% accuracy on them. Bottom: unrestricted adversarial samples obtained after 500 iterations of latent variable optimization, DenseNet has 0% accuracy on them. 

![CleanACGAN](https://user-images.githubusercontent.com/13089230/63454653-14d41c00-c400-11e9-9dce-994e40ce180b.png)
![AdvACGAN](https://user-images.githubusercontent.com/13089230/63454654-14d41c00-c400-11e9-8921-a2a7bbf38239.png)

## Results
![Table](https://user-images.githubusercontent.com/13089230/63455307-64ffae00-c401-11e9-9ef8-67203bf496f8.png)

The tables show final accuracy for different augmentation techniques. While we confirm that training with adversarial samples (FGSM) negatively impacts the final accuracy, using samples from our AC-GAN doesn't significantly impact the final accuracy (although there is a slight gain).

One possible explanation for the lack of accuracy gain is that the unrestricted adversarial samples are not diversified enough. As shown below, the classifier is able to reach a high accuracy on the generated samples early in the training. 

![Learning](https://user-images.githubusercontent.com/13089230/63454650-14d41c00-c400-11e9-8442-e3c6101c8074.png)

## Repository Usage 
### Pre-requisites

### Training AC-GAN:
> python train_acgan.py

### Training classifier:
> python main.py 

### Training classifier with FGSM 
> python main.py --adversarial_mode fgsm 

### Training classifier with GAN samples 
> python main.py --adversarial_mode gan --gen_name <name of GAN to use>

### Training classifier with unrestricted adversarial examples 
> python train_unrestricted.py
